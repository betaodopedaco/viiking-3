(function() {
  // Cria o container do chat
  const chatContainer = document.createElement('div');
  chatContainer.id = 'chat-container';
  chatContainer.style.position = 'fixed';
  chatContainer.style.bottom = '20px';
  chatContainer.style.right = '20px';
  chatContainer.style.width = '300px';
  chatContainer.style.padding = '10px';
  chatContainer.style.backgroundColor = '#222';
  chatContainer.style.color = '#fff';
  chatContainer.style.borderRadius = '10px';
  chatContainer.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
  chatContainer.style.fontFamily = 'Arial, sans-serif';
  document.body.appendChild(chatContainer);

  // Input do cliente
  const clientInput = document.createElement('select');
  clientInput.id = 'chat-client';
  const clients = [
    { id: 'clienteA', label: 'Homero/Gaia' },
    { id: 'clienteB', label: 'Bolsonarista' }
  ];
  clients.forEach(c => {
    const option = document.createElement('option');
    option.value = c.id;
    option.innerText = c.label;
    clientInput.appendChild(option);
  });
  chatContainer.appendChild(clientInput);

  // Input da mensagem
  const input = document.createElement('input');
  input.id = 'chat-input';
  input.placeholder = 'Digite sua mensagem...';
  input.style.width = '100%';
  input.style.marginTop = '5px';
  input.style.padding = '5px';
  chatContainer.appendChild(input);

  // Área de respostas
  const output = document.createElement('div');
  output.id = 'chat-output';
  output.style.marginTop = '10px';
  output.style.maxHeight = '200px';
  output.style.overflowY = 'auto';
  chatContainer.appendChild(output);

  // Função de enviar mensagem
  function sendMessage() {
    const message = input.value.trim();
    if (!message) return;
    const client_id = clientInput.value;
    input.value = '';

    const userBubble = document.createElement('div');
    userBubble.innerText = `Você: ${message}`;
    userBubble.style.marginBottom = '5px';
    userBubble.style.textAlign = 'right';
    output.appendChild(userBubble);

    fetch('https://viiking-3-6.onrender.com/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message, client_id, session_id: 'default' })
    })
    .then(response => response.json())
    .then(data => {
      const botMessage = data.response || 'Sem resposta';
      const botBubble = document.createElement('div');
      botBubble.innerText = `Bot: ${botMessage}`;
      botBubble.style.marginBottom = '5px';
      botBubble.style.textAlign = 'left';
      output.appendChild(botBubble);
      output.scrollTop = output.scrollHeight;
    })
    .catch(error => {
      console.error('Erro:', error);
      const errBubble = document.createElement('div');
      errBubble.innerText = `Erro: ${error}`;
      errBubble.style.color = 'red';
      output.appendChild(errBubble);
    });
  }

  // Evento Enter para enviar
  input.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendMessage();
  });
})();
